import{b as y,d,e as b,g as l}from"./chunk-CPSYCWXI.js";import{E as g,F as E,I as N,K as p,L as S,M as T,N as f,O as v,a as m}from"./chunk-W6FKDBEB.js";import{k as I}from"./chunk-LNU3NAQS.js";import{$ as h,La as A,S as R,X as n,ca as U}from"./chunk-HVYCA3GY.js";import{g as o,i as a}from"./chunk-4H2XPKAU.js";var c=class c{constructor(){o(this,"auth",n(E));o(this,"firestore",n(y));o(this,"userService",n(m));o(this,"router",n(I));o(this,"ngZone",n(A));o(this,"injector",n(U));let r=this.auth,e=this.injector;p(r,s=>{h(e,()=>{let t=this.router.url;s?this.loadUser(s):(this.userService.logout(),!t.startsWith("/auth")&&!t.startsWith("/onboarding")&&this.router.navigateByUrl("/auth/login"))})})}login(r,e){return a(this,null,function*(){let s=yield T(this.auth,r,e)})}loginWithGoogle(){return a(this,null,function*(){let r=new g,e=yield f(this.auth,r)})}register(r,e){return a(this,null,function*(){let s=yield N(this.auth,r,e);return h(this.injector,()=>a(this,null,function*(){let t=s.user.uid,i={uid:t,email:r,nombre:"",rol:"cliente",permisos:["ejecutar_rutinas"]};yield l(d(this.firestore,"users",t),i),this.userService.setUsuario(i)}))})}completarOnboarding(r,e){return a(this,null,function*(){let s=this.auth.currentUser;if(!s)throw new Error("No hay usuario autenticado");return h(this.injector,()=>a(this,null,function*(){var u;let t=s.uid,i={uid:t,email:(u=s.email)!=null?u:"",nombre:r.trim(),rol:e,permisos:[]};switch(e){case"cliente":i.clienteId=t,i.permisos=["ejecutar_rutinas"];break;case"entrenador":i.entrenadorId=t,i.permisos=["crear_rutinas","ejecutar_rutinas"];break;case"gimnasio":case"personal trainer":i.gimnasioId=t,i.permisos=["GESTIONAR_USUARIOS","crear_rutinas","ejecutar_rutinas"];break}yield l(d(this.firestore,"users",t),i),this.userService.setUsuario(i)}))})}resetPassword(r){return S(this.auth,r)}logout(){return a(this,null,function*(){yield v(this.auth),this.userService.logout(),this.router.navigateByUrl("/auth/login")})}loadUser(r){return a(this,null,function*(){var i,u;let e=d(this.firestore,"users",r.uid),s=yield b(e),t;return s.exists()?t=s.data():(t={uid:r.uid,email:(i=r.email)!=null?i:"",nombre:(u=r.displayName)!=null?u:"",rol:"cliente",permisos:["ejecutar_rutinas"]},yield l(e,t)),this.userService.setUsuario(t),this.needsOnboarding(t)?this.router.navigateByUrl("/onboarding"):this.redirectToSection(t),t})}redirectToSection(r){switch(r.rol){case"cliente":this.router.navigateByUrl("/cliente");break;case"entrenador":this.router.navigateByUrl("/entrenador");break;case"gimnasio":case"personal trainer":this.router.navigateByUrl("/gimnasio");break;default:this.router.navigateByUrl("/onboarding");break}}needsOnboarding(r){return!r.nombre||!r.rol||(r.rol==="gimnasio"||r.rol==="personal trainer")&&!r.gimnasioId}};o(c,"\u0275fac",function(e){return new(e||c)}),o(c,"\u0275prov",R({token:c,factory:c.\u0275fac,providedIn:"root"}));var w=c;export{w as a};
